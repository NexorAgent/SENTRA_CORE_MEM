# SENTRA_CORE_MEM ‚Äî M√©moire IA autonome üß†

**SENTRA_CORE_MEM** est un noyau IA capable de compresser ses souvenirs, d'orchestrer plusieurs agents, de fonctionner hors SaaS et maintenant d'exploiter un cortex IA local (DeepSeek R1) connect√© en API. Le projet reste enti√®rement open source et modulable.

---

## Objectif
- M√©moriser chaque interaction utile
- R√©sumer √† trois niveaux (humain, hybride, glyphique)
- Mobiliser des agents d√©di√©s (Markdown, Notion, Discord‚Ä¶)
- Optimiser l'usage des tokens et la m√©moire centrale (vectorielle)
- B√©n√©ficier d‚Äôune IA reasoning en local (DeepSeek R1/7B via Ollama)
- Orchestrer l‚Äôautomatisation via n8n, fallback cloud/local

---

## Architecture actuelle (MAJ 2025-07-15)

- **VPS OVH** : orchestration, m√©moire centrale (ChromaDB), API REST (FastAPI), agents et automatisations (n8n), backups, logs, tra√ßabilit√©
- **PC local (DeepSeek R1/7B quantis√©)** : reasoning, r√©sum√©, brainstorming, agents sp√©cialis√©s (via Ollama/llama.cpp, API REST locale ou tunnel s√©curis√©)
- **Interop√©rabilit√©** : tunnel Cloudflare s√©curis√© et reverse proxy HTTPS
- **Docker Compose** : orchestration des services API, Discord, n8n et volumes
- **Fallback IA** : bascule automatique OpenAI ‚Üí DeepSeek local pour le reasoning

---

## Structure du projet
```text
sentra_core_mem/
‚îú‚îÄ‚îÄ memory/            # M√©moire compress√©e (.json)
‚îú‚îÄ‚îÄ scripts/           # Encodeurs, agents, automatisations
‚îú‚îÄ‚îÄ sentra/            # Noyau, orchestrateur, vector search
‚îú‚îÄ‚îÄ reports/           # Rapports g√©n√©r√©s
‚îú‚îÄ‚îÄ logs/              # Journaux d'ex√©cution
‚îú‚îÄ‚îÄ docs/              # Documentation, changelog, plannings
‚îú‚îÄ‚îÄ docker-compose.yml # Orchestration API, n8n, Discord, etc.
‚îî‚îÄ‚îÄ projects/          # Multim√©moire, journal, sandbox/prod
```

## Installation et configuration
Cloner le d√©p√¥t¬†:

bash
Copier
Modifier
git clone https://github.com/sentra-core/sentra_core_mem.git
cd sentra_core_mem
Cr√©er un environnement virtuel puis installer les d√©pendances¬†:

bash
Copier
Modifier
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
Copier .env.example en .env et renseigner les cl√©s¬†:

ini
Copier
Modifier
OPENAI_API_KEY=sk-...
NOTION_TOKEN=secret_...
NOTION_DB_ID=abcd1234...
DISCORD_BOT_TOKEN=MTA...
V√©rifier configs/config.json puis lancer le test rapide¬†:

bash
Copier
Modifier
python scripts/sentra_check.py
Aucun fichier .env n'est fourni dans le d√©p√¥t¬†; chaque environnement garde ses cl√©s priv√©es.

Utilisation de l'API
D√©marrer l'API FastAPI
Pour tester localement l'API (plugin ChatGPT), lancez¬†:

bash
Copier
Modifier
uvicorn scripts.api_sentra:app --reload --port 5000

### Outils MCP disponibles

L'API FastAPI expose d√©sormais ses capacit√©s sous forme d'outils MCP. Chaque requ√™te transporte au minimum le champ `user` pour l'audit et, lorsqu'une √©criture est r√©alis√©e, un `agent` permettant d'attribuer l'action.

- **`files.read`** (`POST /files/read`) ‚Äì lit un fichier dans `/projects`, `/reports` ou `/students`.
  ```json
  {
    "user": "ops",
    "path": "/projects/demo/fichiers/todo.md"
  }
  ```
- **`files.write`** (`POST /files/write`) ‚Äì cr√©e ou met √† jour un fichier et pousse l'artefact dans Git.
  ```json
  {
    "user": "ops",
    "agent": "scribe",
    "path": "/projects/demo/fichiers/todo.md",
    "content": "- [ ] Pr√©parer la d√©mo",
    "idempotency_key": "todo-v1"
  }
  ```
- **`memory.note.add`** (`POST /memory/note/add`) ‚Äì ajoute une note horodat√©e √† la m√©moire centrale.
  ```json
  {
    "user": "ops",
    "agent": "scribe",
    "note": {
      "text": "Organiser la r√©union de planification",
      "tags": ["planning", "demo"],
      "metadata": {"source": "discord"},
      "note_id": "planning-001"
    }
  }
  ```
- **`memory.note.find`** (`POST /memory/note/find`) ‚Äì effectue une recherche full-text ou par tags.
  ```json
  {
    "user": "ops",
    "query": "r√©union demo",
    "tags": ["planning"],
    "limit": 5
  }
  ```
- **`bus.send`** (`POST /bus/send`) ‚Äì publie un message structur√© dans la feuille Google "bus".
  ```json
  {
    "user": "ops",
    "agent": "dispatcher",
    "spreadsheet_id": "1Abc...",
    "worksheet": "bus",
    "payload": {
      "from": "sentra",
      "to": "codex",
      "topic": "draft",
      "goal": "Ship v2 spec"
    },
    "idempotency_key": "draft-2025-01-20"
  }
  ```
- **`bus.poll`** (`POST /bus/poll`) ‚Äì r√©cup√®re les messages suivant un statut donn√©.
  ```json
  {
    "user": "ops",
    "spreadsheet_id": "1Abc...",
    "worksheet": "bus",
    "status": "pending",
    "limit": 10
  }
  ```
- **`bus.updateStatus`** (`POST /bus/updateStatus`) ‚Äì cl√¥ture ou relance un message du bus.
  ```json
  {
    "user": "ops",
    "agent": "dispatcher",
    "spreadsheet_id": "1Abc...",
    "worksheet": "bus",
    "message_id": "bus-2025-0001",
    "status": "done"
  }
  ```
- **`gcal.create_event`** (`POST /google/gcal/create_event`) ‚Äì planifie un √©v√©nement dans Google Agenda.
  ```json
  {
    "user": "ops",
    "agent": "calendar",
    "calendar_id": "primary",
    "summary": "Demo SENTRA",
    "description": "Synchro produit",
    "location": "Visio",
    "start": "2025-01-20T09:00:00Z",
    "end": "2025-01-20T10:00:00Z",
    "timezone": "Europe/Paris",
    "attendees": ["lead@example.com"],
    "idempotency_key": "demo-2025-01-20"
  }
  ```
- **`gdrive.upload`** (`POST /google/gdrive/upload`) ‚Äì envoie un fichier (base64) vers Google Drive.
  ```json
  {
    "user": "ops",
    "agent": "uploader",
    "name": "rapport.pdf",
    "mime_type": "application/pdf",
    "content_base64": "JVBERi0xLjQKJ...",
    "folder_id": "abc123"
  }
  ```
- **`rag.index`** (`POST /rag/index`) ‚Äì indexe un lot de documents dans la collection ChromaDB.
  ```json
  {
    "user": "ops",
    "agent": "rag-writer",
    "collection": "prod-notes",
    "documents": [
      {
        "text": "Spec SENTRA v2",
        "metadata": {"source": "wiki"},
        "id": "spec-v2"
      }
    ]
  }
  ```
- **`rag.query`** (`POST /rag/query`) ‚Äì interroge la collection vectorielle et renvoie les passages les plus proches.
  ```json
  {
    "user": "ops",
    "collection": "prod-notes",
    "query": "r√©sum√© architecture",
    "n_results": 3
  }
  ```

Chaque `files.write` d√©clenche automatiquement un `git commit` suivi d'un `git push`. Les notes restent sauvegard√©es dans `memory/sentra_memory.json` ainsi que dans `projects/<nom>/fichiers/Z_MEMORIAL.md`. Lorsqu‚Äôun champ `project` est fourni, elles sont aussi ajout√©es dans `projects/<slug>/fichiers/memoire_<slug>.md`.

#### Bus Google Sheet & workflow `bus-dispatch`

Le bus d'orchestration repose sur une feuille Google Sheet structur√©e avec les colonnes `id | ts | from | to | topic | goal | context_json | status | error | last_update`¬†:

- `id` ‚Äì identifiant unique g√©n√©r√© par `bus.send` (utilis√© pour les mises √† jour).
- `ts` ‚Äì horodatage d'insertion.
- `from` / `to` ‚Äì agent source et cible.
- `topic` ‚Äì sujet court lisible.
- `goal` ‚Äì objectif d√©taill√© transmis aux agents.
- `context_json` ‚Äì charge utile compl√®te s√©rialis√©e (JSON).
- `status` ‚Äì √©tat du message (`pending`, `queued`, `running`, `done`, `error`).
- `error` ‚Äì dernier message d'erreur remont√© par un agent.
- `last_update` ‚Äì date de la derni√®re modification par un outil ou un op√©rateur.

Le workflow n8n `bus-dispatch` se d√©ploie en trois √©tapes¬†: (1) un n≈ìud *Google Sheets Watch* √©coute les lignes dont le `status` est `pending`; (2) un n≈ìud *Discord* publie la mission sur le canal op√©rateurs avec un lien vers la ligne ; (3) un n≈ìud *Google Sheets Update* applique la r√©ponse (nouveau `status`, horodatage `last_update`, √©ventuel `error`). Ainsi, toute boucle `bus.send ‚Üí bus.poll ‚Üí bus.updateStatus` reste synchronis√©e entre la feuille, Discord et les agents SENTRA.

## üîí Obfuscation glyphique
L'option `--obfuscate` du script `run_auto_translator.py` attribue des glyphes al√©atoires √† chaque balise. Le mapping g√©n√©r√© est √©crit dans un fichier `<nom>_mapping.json` (ou chemin d√©fini par `--map-out`). **Attention¬†:** perdre ce fichier rend la d√©compression impossible. Conservez-le pr√©cieusement ou lancez le script sans obfuscation si la r√©cup√©ration pr√©vaut.

Pour restaurer un texte¬†:
```python
from scripts.glyph.glyph_generator import decompress_with_dict
import json
mapping = json.load(open("FICHIER_mapping.json", "r", encoding="utf-8"))
plain = decompress_with_dict(glyph_text, mapping)
```

## üîÑ Vue d'ensemble du workflow
Un cycle complet peut √™tre ex√©cut√© manuellement ou via scheduler¬†:
```
encode ‚Üí load ‚Üí sync ‚Üí report
```
Le script `sentra/orchestrator.py` centralise ces √©tapes et g√®re la distribution vers les agents.

## üìñ Exemples d'utilisation
### Cr√©er et interroger une m√©moire
```bash
python scripts/zmem_encoder.py -i docs/mon_texte.txt -n DEMO/MEM
python scripts/compose_prompt.py DEMO/MEM
```
üìñ Exemples d'utilisation avanc√©e
Orchestration m√©moire : vector search (ChromaDB), r√©sum√© markdown, fusion intelligente de notes

Brainstorming/code/veille par DeepSeek R1 via API Ollama (voir planning)

Automatisation n8n¬†: backup, synchronisation, extraction, dashboard, surveillance
### Exemple n8n
1. **HTTP Request** ‚Üí `POST /memory/note/add` avec un contenu g√©n√©r√©
2. **GitHub** ‚Üí `pull` puis `push` automatique
3. **Discord** ‚Üí alerte en cas d‚Äô√©chec
Le tout expos√© derri√®re Cloudflare pour s√©curiser l'acc√®s.
```

### Orchestrateur & agents
```bash
# Encodage via l'orchestrateur
python sentra/orchestrator.py encode --input docs/mon_texte.txt --name DEMO/MEM

# Synchronisation Notion + Discord
python sentra/orchestrator.py sync --target all

# G√©n√©ration de rapport pour une date
python sentra/orchestrator.py report --date 2025-06-01
```
Les agents peuvent aussi √™tre appel√©s directement¬†:
```bash
python scripts/agent_markdown.py           # Rapport Markdown
python scripts/agent_notion.py             # Synchronisation Notion
python sentra/zarch.py --query "Alpha"     # Recherche dans la m√©moire
```

### Autres scripts utiles
```bash
python scripts/archive.py       # Archiver le projet
python scripts/main.py          # Test global de l'installation
```
> **Aucun fichier .env n‚Äôest fourni dans le repo.**
> La cl√© reste priv√©e sur chaque environnement.

Les scripts Python lisent automatiquement la cl√© avec¬†:
```python
import os
openai.api_key = os.getenv("OPENAI_API_KEY")
```

## Documentation compl√©mentaire
- [CHANGELOG](docs/CHANGELOG.md)
- [PLANNING](docs/PLANNING_SENTRA_CORE_MEM.md)

En mode Render/cloud, le push git effectif n√©cessite un token/cl√© SSH configur√©. Les endpoints sont s√©curis√©s par obscurit√© (non publics) mais peuvent √™tre prot√©g√©s (bearer token, etc.).

### Docker Compose
Un fichier `docker-compose.yml` permet de lancer l'API FastAPI, le bot Discord, n8n et l'orchestrateur¬†:
```bash
docker compose up -d
```

üß≠ PHASE 0 ‚Äì Audit & Pr√©paration (Semaine 0)
üéØ Objectif :
Pr√©parer le terrain c√¥t√© VPS pour accueillir toute l‚Äôarchitecture SENTRA_CORE_MEM (API, Orchestrateur, n8n, etc.) de fa√ßon s√©curis√©e, stable et document√©e.

‚úÖ 0.1 ‚Äî Audit du VPS
üîç V√©rifier les ressources disponibles
Connecte-toi en SSH :

bash
Copier
Modifier
ssh debian@<IP_DU_VPS>
Et lance les commandes suivantes :

bash
Copier
Modifier
# CPU
lscpu

# RAM
free -h

# Stockage
df -h

# R√©seau + nom machine
hostnamectl && ip a
üìå Objectif : confirmer que ton VPS a au moins 2 vCPU, 4 Go RAM et 20 Go de libre pour les besoins de base.

üîê V√©rification s√©curit√© SSH
bash
Copier
Modifier
# V√©rifie si fail2ban est install√©
sudo systemctl status fail2ban

# V√©rifie si UFW est actif
sudo ufw status verbose
üîß Si n√©cessaire :

bash
Copier
Modifier
# Installer fail2ban
sudo apt install fail2ban -y

# Installer et activer UFW
sudo apt install ufw -y
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw enable
üê≥ 0.2 ‚Äî Installation Docker / Docker Compose / Git
bash
Copier
Modifier
# Mise √† jour
sudo apt update && sudo apt upgrade -y

# Installation Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Ajout de l‚Äôutilisateur au groupe Docker
sudo usermod -aG docker $USER
newgrp docker

# V√©rification Docker
docker --version

# Docker Compose plugin (Debian >= 11)
sudo apt install docker-compose-plugin -y
docker compose version

# Installation Git
sudo apt install git -y
git --version
üìÅ 0.3 ‚Äî Cr√©ation du dossier projet "propre"
bash
Copier
Modifier
# Clonage du projet
git clone https://github.com/NexorAgent/SENTRA_CORE_MEM.git
cd SENTRA_CORE_MEM

# Cr√©ation du .env
cp .env.example .env
nano .env  # (adapter les cl√©s API, ports, etc.)
üìÑ 0.4 ‚Äî R√©daction documentation initiale
Cr√©e un fichier README_PHASE0.md avec :

markdown
Copier
Modifier
# üìÑ SENTRA_CORE_MEM ‚Äî Phase 0 : Audit & Pr√©paration

## üîç VPS
- CPU : 2vCPU
- RAM : 4 Go
- Disque libre : 25 Go
- Nom de machine : sentra-core
- OS : Debian 11

## üîê S√©curit√©
- SSH activ√©, port : 22
- Fail2ban actif
- UFW actif, r√®gles :
  - allow ssh
  - allow 80, 443 (pour Nginx / tunnel)
- OVH Firewall externe : d√©sactiv√© (si cloudflared)

## üê≥ Docker & Git
- Docker : ‚úÖ install√©
- Docker Compose : ‚úÖ OK (v2)
- Git : ‚úÖ install√©

## üìÅ Dossier projet
- Structure clon√©e depuis GitHub
- .env g√©n√©r√© avec cl√©s API

## ‚úÖ V√©rifications OK
- SSH : ‚úÖ
- Git : ‚úÖ
- Docker : ‚úÖ
- Ports API & n8n ouverts : ‚úÖ
‚úÖ 0.5 ‚Äî V√©rification finale
bash
Copier
Modifier
# Tester que tout fonctionne
docker --version
docker compose version
git status
üì¶ Fichiers √† ajouter au Git (si projet priv√©)
plaintext
Copier
Modifier
üìÅ SENTRA_CORE_MEM/
‚îú‚îÄ‚îÄ README_PHASE0.md
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .gitignore
Tu peux aussi pousser les premi√®res infos d‚Äôaudit dans ton repo Git :

bash
Copier
Modifier
git add README_PHASE0.md
git commit -m "Ajout audit phase 0"
git push origin main
‚è±Ô∏è Dur√©e estim√©e
√âtape	Dur√©e max
Audit SSH + CPU/RAM	10 min
Installation Docker/Git	20 min
Configuration UFW	10 min
Clonage + .env	10 min
R√©daction README audit	15 min

‚è≥ Total : 1h max si tout est pr√™t.

¬© 2025 ‚Äî Projet open‚Äësource modulable ‚ú®

## ‚úÖ Tests automatis√©s

Le paquet `tests/` contient une suite Pytest rafra√Æchie couvrant chaque outil MCP (`files`, `memory`, `bus`, `google`, `rag`) en plus du sc√©nario E2E (marqu√© `slow`). Les fixtures isolent les d√©pendances externes (Git, Google Sheet, n8n, Discord) en les simulant.

```bash
pytest -k "files"
pytest -k "memory"
pytest -k "bus"
pytest -k "google"
pytest -k "rag"
```

Lancer `pytest` sans filtre ex√©cute l'ensemble de la suite, et `pytest -m "not slow"` permet d'exclure le test de bout en bout si besoin.

## Licence
Ce projet est distribu√© sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus d'informations.
